<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geriatrics Bilingual Survey</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          // These are not strictly necessary with Tailwind JIT (included in CDN)
          // as arbitrary values like min-w-[150px] work out-of-the-box.
          // However, they don't hurt.
          minWidth: {
            '[150px]': '150px',
          },
          maxWidth: {
            '[400px]': '400px',
          }
        }
      }
    }
  </script>
  <style>
    /* Custom styles for better RTL handling with Tailwind if needed, or minor tweaks */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Ensure Likert numbers are LTR even in RTL page */
    .likert-options-ltr {
        direction: ltr;
    }
    /* Custom focus style for better visibility */
    input:focus, select:focus {
        outline: 2px solid #2563eb; /* Tailwind's blue-600 */
        outline-offset: 1px;
    }
    /* Styling for the custom validation message for inputs and radio buttons */
    .input-error-message, .radio-error-message {
        color: #ef4444; /* Tailwind's red-500 */
        font-size: 0.75rem; /* text-xs */
        margin-top: 0.25rem; /* mt-1 */
    }
    .mmse-drawing {
        width: 150px;
        height: 100px;
        margin-right: auto; /* RTL: margin on the right for auto (pushes to visual right / page left) */
        margin-left: 0;     /* RTL: reset left margin */
        border: 1px solid #ccc; /* Tailwind gray-300 equivalent */
        padding: 0.25rem; /* p-1 */
        border-radius: 0.375rem; /* rounded-md */
    }
    @media (min-width: 640px) { /* sm breakpoint */
        .mmse-drawing {
             margin-right: auto; /* Center on larger screens */
             margin-left: auto;  /* Center on larger screens */
        }
    }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8 font-sans">
  <form id="surveyForm" class="max-w-3xl mx-auto">

    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-1">
      <h2 class="text-2xl font-semibold text-sky-700 mb-6">معلومات عامة / General Information</h2>
      
      <label for="age" class="block text-gray-700 mb-1">العمر / Age:</label>
      <select id="age" name="age" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
        <option value="">اختر / Select</option>
        <option value="65-75">٦٥-٧٥ / 65-75</option>
        <option value="76-85">٧٦-٨٥ / 76-85</option>
        <option value=">85">أكثر من ٨٥ / More than 85</option>
      </select>

      <label for="gender" class="block text-gray-700 mt-4 mb-1">الجنس / Gender:</label>
      <select id="gender" name="gender" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
        <option value="">اختر / Select</option>
        <option value="male">ذكر / Male</option>
        <option value="female">أنثى / Female</option>
      </select>

      <label for="marital" class="block text-gray-700 mt-4 mb-1">الحالة الاجتماعية / Marital Status:</label>
      <select id="marital" name="marital" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
        <option value="">اختر / Select</option>
        <option value="single">أعزب / Single</option>
        <option value="married">متزوج / Married</option>
        <option value="divorced">مطلق / Divorced</option>
        <option value="widowed">أرمل / Widowed</option>
      </select>

      <label for="education" class="block text-gray-700 mt-4 mb-1">التحصيل العلمي / Educational Attainment:</label>
      <select id="education" name="education" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
        <option value="">اختر / Select</option>
        <option value="illiterate">أُمِّي / Illiterate</option>
        <option value="read_write">يقرأ ويكتب / Reads and Writes</option>
        <option value="primary">التعليم الابتدائي / Primary Education</option>
        <option value="preparatory">التعليم الإعدادي / Preparatory Education</option>
        <option value="secondary">التعليم الثانوي / Secondary Education</option>
        <option value="diploma">دبلوم / Diploma</option>
        <option value="bachelor">بكالوريوس / Bachelor's</option>
        <option value="master">ماجستير / Master's</option>
        <option value="doctorate">دكتوراه / Doctorate</option>
      </select>
      
      <div class="text-center mt-8">
        <button type="button" onclick="nextSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-blue-600 text-white border-none rounded-md hover:bg-blue-700 transition-colors">التالي / Next</button>
      </div>
    </div>

    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-2">
      <h2 class="text-2xl font-semibold text-sky-700 mb-4">MMSE – المهارات الإدراكية (30 نقطة)</h2>
      <p class="text-gray-600 mb-6">ضع علامة (✓) للإجابات الصحيحة / Mark (✓) for correct answers.</p>
      <div class="space-y-3">
        <p class="font-semibold text-gray-800">مهارة تحديد وضع المريض زمانيًا ومكانيًا / Orientation to Time and Place (10 points)</p>
        <div class="question flex items-center"><span class="font-bold me-2">1.</span> اليوم / Day <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">2.</span> التاريخ / Date <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">3.</span> الشهر / Month <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">4.</span> الفصل / Season <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">5.</span> السنة / Year <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">6.</span> أين نحن (في أي مستشفى/مكان) / Where are we (Hospital/Place) <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">7.</span> في أي طابق / Which floor <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">8.</span> في أية مدينة / Which city <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">9.</span> في أية منطقة/محافظة / Which region/province <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">10.</span> في أي بلد / Which country <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        
        <p class="font-semibold text-gray-800 mt-4">القدرة على الحفظ / Registration (3 points)</p>
        <div class="question mt-1">
            <p class="mb-1">ردد ورائي: حامض، مفتاح، طابة / Repeat after me: Lemon, Key, Ball</p>
            <div class="flex items-center mt-1"><span class="font-bold me-2">11.</span><label for="mmse_lemon1" class="cursor-pointer flex-grow">حامض / Lemon</label><input type="checkbox" name="mmse" value="1" id="mmse_lemon1" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">12.</span><label for="mmse_key1" class="cursor-pointer flex-grow">مفتاح / Key</label><input type="checkbox" name="mmse" value="1" id="mmse_key1" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">13.</span><label for="mmse_ball1" class="cursor-pointer flex-grow">طابة / Ball</label><input type="checkbox" name="mmse" value="1" id="mmse_ball1" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        </div>

        <p class="font-semibold text-gray-800 mt-4">الانتباه والحساب / Attention and Calculation (5 points)</p>
        <div class="question mt-1">
            <p class="mb-1">إطرح من الرقم مئة (١٠٠) الرقم سبعة (٧) خمس مرات متتالية / Subtract 7 from 100, five consecutive times.</p>
            <div class="flex items-center mt-1"><span class="font-bold me-2">14.</span><label for="mmse_calc1" class="cursor-pointer flex-grow">93</label><input type="checkbox" name="mmse" value="1" id="mmse_calc1" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">15.</span><label for="mmse_calc2" class="cursor-pointer flex-grow">86</label><input type="checkbox" name="mmse" value="1" id="mmse_calc2" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">16.</span><label for="mmse_calc3" class="cursor-pointer flex-grow">79</label><input type="checkbox" name="mmse" value="1" id="mmse_calc3" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">17.</span><label for="mmse_calc4" class="cursor-pointer flex-grow">72</label><input type="checkbox" name="mmse" value="1" id="mmse_calc4" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">18.</span><label for="mmse_calc5" class="cursor-pointer flex-grow">65</label><input type="checkbox" name="mmse" value="1" id="mmse_calc5" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        </div>

        <p class="font-semibold text-gray-800 mt-4">التذكر / Recall (3 points)</p>
        <div class="question mt-1">
            <p class="mb-1">اذكر الكلمات الثلاث التي رددتها قبل قليل / Recall the three words you repeated earlier.</p>
            <div class="flex items-center mt-1"><span class="font-bold me-2">19.</span><label for="mmse_lemon2" class="cursor-pointer flex-grow">حامض / Lemon</label><input type="checkbox" name="mmse" value="1" id="mmse_lemon2" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">20.</span><label for="mmse_key2" class="cursor-pointer flex-grow">مفتاح / Key</label><input type="checkbox" name="mmse" value="1" id="mmse_key2" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
            <div class="flex items-center mt-1"><span class="font-bold me-2">21.</span><label for="mmse_ball2" class="cursor-pointer flex-grow">طابة / Ball</label><input type="checkbox" name="mmse" value="1" id="mmse_ball2" class="ms-2 me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        </div>

        <p class="font-semibold text-gray-800 mt-4">لغة التعبير والأوامر / Language and Commands (9 points)</p>
        <div class="question flex items-center"><span class="font-bold me-2">22.</span> ما هذا؟ (اظهر له قلمًا) / What is this? (Show a pen) <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">23.</span> ما هذه؟ (اظهر له ساعة) / What is this? (Show a watch) <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">24.</span> اصغ وكرر الجملة التالية: "لا إذا، ولا لكن" / Listen and repeat: "No ifs, ands, or buts" <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        
        <p class="mt-2 mb-1">يطلب تحقيق الامر التالي قسمًا تلو الاخر / Follow these commands one by one:</p>
        <div class="question flex items-center"><span class="font-bold me-2">25.</span> خذ الورقة باليد اليمنى / Take the paper with your right hand <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">26.</span> اطوها بشكل نصفي / Fold it in half <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">27.</span> ثم ضعها على الأرض / Then put it on the floor <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>

        <div class="question flex items-center mt-2"><span class="font-bold me-2">28.</span> نفذ ما هو مكتوب امامك: "أغمض عينيك" / Do what is written here: "Close your eyes" <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        <div class="question flex items-center"><span class="font-bold me-2">29.</span> اكتب جملة من اختيارك (جملة مفيدة) / Write a sentence of your choice (a complete sentence) <input type="checkbox" name="mmse" value="1" class="ms-auto me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
        
        <div class="question mt-2">
            <p class="mb-1"><span class="font-bold me-2">30.</span> انسخ هذا الرسم / Copy this drawing:</p>
            <svg width="150" height="100" viewBox="0 0 150 100" xmlns="http://www.w3.org/2000/svg" class="mmse-drawing">
              <polygon points="50,5 90,35 75,80 25,80 10,35" fill="none" stroke="currentColor" stroke-width="2"/>
              <polygon points="80,20 120,50 105,95 55,95 40,50" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
            <div class="flex items-center justify-end mt-1"> <input type="checkbox" name="mmse" value="1" id="mmse_draw" class="me-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="mmse_draw" class="cursor-pointer">تم النسخ بشكل صحيح / Copied correctly</label></div>
        </div>

      </div>
      <div class="text-center mt-8 space-x-reverse space-x-2">
        <button type="button" onclick="prevSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-gray-500 text-white border-none rounded-md hover:bg-gray-600 transition-colors">السابق / Back</button>
        <button type="button" onclick="nextSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-blue-600 text-white border-none rounded-md hover:bg-blue-700 transition-colors">التالي / Next</button>
      </div>
    </div>

    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-3">
      <h2 class="text-2xl font-semibold text-sky-700 mb-6">ADL – أنشطة الحياة اليومية</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-1">النظافة الشخصية / Personal Hygiene:</label>
          <select name="adl_hygiene" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
            <option value="">اختر / Select</option>
            <option value="1">استقلالية تامة / Fully Independent</option>
            <option value="0.5">مساعدة جزئية / Partial Assistance</option>
            <option value="0">معتمد / Dependent</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1">ارتداء الملابس / Dressing:</label>
          <select name="adl_dressing" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
            <option value="">اختر / Select</option>
            <option value="1">استقلالية تامة / Fully Independent</option>
            <option value="0.5">مساعدة بسيطة / Minimal Assistance</option>
            <option value="0">معتمد / Dependent</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1">استخدام المرحاض / Toileting:</label>
          <select name="adl_toilet" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
            <option value="">اختر / Select</option>
            <option value="1">استقلالية تامة / Fully Independent</option>
            <option value="0.5">يحتاج مساعدة / Needs Assistance</option>
            <option value="0">معتمد / Dependent</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1">التنقل / Mobility:</label>
          <select name="adl_mobility" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
            <option value="">اختر / Select</option>
            <option value="1">يمشي بدون مساعدة / Walks without help</option>
            <option value="0.5">يمشي مع مساعدة / Walks with help</option>
            <option value="0">لا يستطيع التحرك / Cannot move</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1">التحكم بالإخراج / Continence:</label>
          <select name="adl_continence" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
            <option value="">اختر / Select</option>
            <option value="1">تحكم كامل / Full control</option>
            <option value="0.5">سلس جزئي / Partial incontinence</option>
            <option value="0">سلس كامل / Full incontinence</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-1">تناول الطعام / Feeding:</label>
          <select name="adl_feeding" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[400px] focus:border-blue-500 focus:ring-blue-500">
            <option value="">اختر / Select</option>
            <option value="1">يأكل بمفرده / Eats independently</option>
            <option value="0.5">يحتاج مساعدة / Needs assistance</option>
            <option value="0">يعتمد كلياً / Fully dependent</option>
          </select>
        </div>
      </div>
      <div class="text-center mt-8 space-x-reverse space-x-2">
        <button type="button" onclick="prevSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-gray-500 text-white border-none rounded-md hover:bg-gray-600 transition-colors">السابق / Back</button>
        <button type="button" onclick="nextSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-blue-600 text-white border-none rounded-md hover:bg-blue-700 transition-colors">التالي / Next</button>
      </div>
    </div>

    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-4">
      <h2 class="text-2xl font-semibold text-sky-700 mb-4">GDS-15 – مقياس الاكتئاب للمسنين</h2>
      <p class="text-gray-600 mb-6">أجب بنعم أو لا عن كل سؤال / Answer Yes or No. <br class="sm:hidden">(النقاط بين قوسين تشير إلى إجابة تدل على الاكتئاب / Points in parentheses indicate depressive answer)</p>
      <div class="space-y-4">
        <div class="question">
            <p class="mb-1">1. هل أنت راضٍ عن حياتك بشكل أساسي؟ / Are you basically satisfied with your life? (لا = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds1" value="0" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds1" value="1" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">2. هل تخليت عن كثير من نشاطاتك واهتماماتك؟ / Have you dropped many of your activities and interests? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds2" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds2" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">3. هل تشعر أن حياتك فارغة؟ / Do you feel that your life is empty? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds3" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds3" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
         <div class="question">
            <p class="mb-1">4. هل غالبًا ما يصيبك الملل؟ / Do you often get bored? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds4" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds4" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">5. هل أنت في معنويات جيدة معظم الوقت؟ / Are you in good spirits most of the time? (لا = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds5" value="0" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds5" value="1" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">6. هل تخاف من أن شيئًا سيئًا سيحدث لك؟ / Are you afraid that something bad is going to happen to you? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds6" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds6" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">7. هل تشعر بالسعادة معظم الوقت؟ / Do you feel happy most of the time? (لا = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds7" value="0" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds7" value="1" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">8. هل تشعر بالعجز في كثير من الأحيان؟ / Do you often feel helpless? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds8" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds8" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">9. هل تفضل البقاء في المنزل بدلاً من الخروج وعمل أشياء جديدة؟ / Do you prefer to stay at home, rather than going out and doing new things? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds9" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds9" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">10. هل تشعر أن لديك مشاكل في الذاكرة أكثر من معظم الناس؟ / Do you feel you have more problems with memory than most? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds10" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds10" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">11. هل تعتقد أنه من الرائع أن تكون على قيد الحياة الآن؟ / Do you think it is wonderful to be alive now? (لا = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds11" value="0" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds11" value="1" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">12. هل تشعر بأنك لا قيمة لك كما أنت الآن؟ / Do you feel pretty worthless the way you are now? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds12" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds12" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">13. هل تشعر بأنك مفعم بالطاقة؟ / Do you feel full of energy? (لا = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds13" value="0" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds13" value="1" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">14. هل تشعر أن وضعك ميؤوس منه؟ / Do you feel that your situation is hopeless? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds14" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds14" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
        <div class="question">
            <p class="mb-1">15. هل تعتقد أن معظم الناس أفضل حالاً منك؟ / Do you think that most people are better off than you are? (نعم = 1)</p>
            <div class="flex space-x-4 space-x-reverse">
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds15" value="1" required class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> نعم / Yes</label>
                <label class="flex items-center cursor-pointer"><input type="radio" name="gds15" value="0" class="me-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> لا / No</label>
            </div>
        </div>
      </div>
      <div class="text-center mt-8 space-x-reverse space-x-2">
        <button type="button" onclick="prevSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-gray-500 text-white border-none rounded-md hover:bg-gray-600 transition-colors">السابق / Back</button>
        <button type="button" onclick="nextSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-blue-600 text-white border-none rounded-md hover:bg-blue-700 transition-colors">التالي / Next</button>
      </div>
    </div>

    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-5">
        <h2 class="text-2xl font-semibold text-sky-700 mb-6">MSPSS – الدعم الاجتماعي المدرك</h2>
        <div class="space-y-6">
            <div class="question">
                <p class="mb-2 text-gray-800">1. هناك شخص مميز بجانبي عندما أحتاجه. / There is a special person who is around when I am in need.</p>
                <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss1" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">2. هناك شخص مميز استطيع أن اشارك أفراحي و أحزاني معه. / There is a special person with whom I can share my joys and sorrows.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss2" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">3. عائلتي تحاول مساعدتي. / My family really tries to help me.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss3" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">4. انال مساعدةعاطفية ودعم من عائلتي. / I get the emotional help and support I need from my family.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss4" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">5. هناك شخصمميز هو/هي مصدر حقيقي للراحة لي. / There is a special person who is a real source of comfort to me.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss5" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">6. اصدقائي يحاولون مساعدتي. / My friends really try to help me.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss6" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">7. بامكاني الإعتماد على أصدقائي عندما تجري الأمور بشكل سيء. / I can count on my friends when things go wrong.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss7" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">8. بامكاني التحدث عن مشاكلي مع عائلتي. / I can talk about my problems with my family.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss8" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">9. عندي أصدقاء استطيع أن اشارك أفراحي و أحزاني معهم. / I have friends with whom I can share my joys and sorrows.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss9" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">10. هناك شخص مميز في حياتي يهتم بمشاعري. / There is a special person in my life who cares about my feelings.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss10" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">11. عائلتي ترغب في مساعدتي لإتخاذ القرارات. / My family is willing to help me make decisions.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss11" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
            <div class="question">
                <p class="mb-2 text-gray-800">12. استطيع أن اتحدث عن مشاكلي مع أصدقائي. / I can talk about my problems with my friends.</p>
                 <div class="likert-scale-container mt-1 mb-5">
                    <div class="flex justify-between text-xs text-gray-500 mb-1 px-1">
                        <span>لا أوافق بشدة / Strongly Disagree</span>
                        <span>أوافق بشدة / Strongly Agree</span>
                    </div>
                    <div data-radio-group-name="mspss12" class="likert-options-ltr flex justify-around items-start mt-1 mb-1 py-1">
                        </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-8 space-x-reverse space-x-2">
            <button type="button" onclick="prevSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-gray-500 text-white border-none rounded-md hover:bg-gray-600 transition-colors">السابق / Back</button>
            <button type="button" onclick="nextSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-blue-600 text-white border-none rounded-md hover:bg-blue-700 transition-colors">التالي / Next</button>
        </div>
    </div>
    
    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-6">
      <h2 class="text-2xl font-semibold text-sky-700 mb-4">UCL-6 – مقياس الشعور بالوحدة</h2>
      <p class="text-gray-600 mb-6">اختر من 0 (أبدًا) إلى 3 (غالبًا) / Choose from 0 (Never) to 3 (Often)</p>
      <div class="space-y-4">
        <div class="question">
            <label for="ucl1" class="block text-gray-700 mb-1">1. كم مرة تشعر بأنك تفتقر إلى الصحبة؟ / How often do you feel that you lack companionship?</label>
            <input type="number" id="ucl1" name="ucl1" min="0" max="3" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[200px] focus:border-blue-500 focus:ring-blue-500">
        </div>
        <div class="question">
            <label for="ucl2" class="block text-gray-700 mb-1">2. كم مرة تشعر بأنك تُركت خارج الأمور (مستبعد)؟ / How often do you feel left out?</label>
            <input type="number" id="ucl2" name="ucl2" min="0" max="3" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[200px] focus:border-blue-500 focus:ring-blue-500">
        </div>
        <div class="question">
            <label for="ucl3" class="block text-gray-700 mb-1">3. كم مرة تشعر بأنك قريب من الآخرين؟ (عكسي) / How often do you feel close to other people? (Reverse Scored)</label>
            <input type="number" id="ucl3" name="ucl3" min="0" max="3" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[200px] focus:border-blue-500 focus:ring-blue-500">
        </div>
        <div class="question">
            <label for="ucl4" class="block text-gray-700 mb-1">4. كم مرة تشعر بأنك تعاني من الوحدة؟ / How often do you feel lonely?</label>
            <input type="number" id="ucl4" name="ucl4" min="0" max="3" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[200px] focus:border-blue-500 focus:ring-blue-500">
        </div>
        <div class="question">
            <label for="ucl5" class="block text-gray-700 mb-1">5. كم مرة تشعر بأنك مهمل أو متروك؟ / How often do you feel neglected or left alone?</label>
            <input type="number" id="ucl5" name="ucl5" min="0" max="3" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[200px] focus:border-blue-500 focus:ring-blue-500">
        </div>
        <div class="question">
            <label for="ucl6" class="block text-gray-700 mb-1">6. كم مرة تشعر بأن الناس معك (يدعمونك)؟ (عكسي) / How often do you feel that people are there for you? (Reverse Scored)</label>
            <input type="number" id="ucl6" name="ucl6" min="0" max="3" required class="block w-full sm:w-auto p-2.5 mt-1 rounded-md border border-gray-300 min-w-[150px] max-w-[200px] focus:border-blue-500 focus:ring-blue-500">
        </div>
      </div>
      <div class="text-center mt-8 space-x-reverse space-x-2">
        <button type="button" onclick="prevSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-gray-500 text-white border-none rounded-md hover:bg-gray-600 transition-colors">السابق / Back</button>
        <button type="button" onclick="nextSection()" class="m-1 px-6 py-2.5 cursor-pointer bg-blue-600 text-white border-none rounded-md hover:bg-blue-700 transition-colors">التالي / Next</button>
      </div>
    </div>

    <div class="section hidden mb-10 p-5 bg-white rounded-lg shadow-lg" id="section-final">
      <h2 class="text-2xl font-semibold text-sky-700 mb-4">شكرًا لمشاركتك / Thank you for your participation</h2>
      <p class="text-gray-600 mb-6">سيتم الآن إرسال إجاباتك. / Your answers will now be submitted.</p>
      <div id="surveyResults" class="mt-4 p-4 border border-gray-200 rounded-md bg-gray-50 text-sm">
          </div>
      <div class="text-center mt-8">
        <button type="submit" id="submitButton" class="m-1 px-6 py-2.5 cursor-pointer bg-green-600 text-white border-none rounded-md hover:bg-green-700 transition-colors">إرسال / Submit</button>
      </div>
    </div>
  </form>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase configuration (expected to be injected, e.g., by a backend)
    const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Unique ID for this app/survey
    
    let firebaseConfig = {};
    try {
        firebaseConfig = JSON.parse(firebaseConfigString);
        if (Object.keys(firebaseConfig).length === 0) {
            console.warn("Firebase config is empty. Firestore saving will be simulated.");
        }
    } catch (e) {
        console.error("Failed to parse Firebase config:", e);
        console.warn("Firestore saving will be simulated.");
    }

    let app;
    let auth;
    let db;
    let canUseFirebase = false;

    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // Set to 'warn' or 'error' for production
            // setLogLevel('debug'); 
            canUseFirebase = true;
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            canUseFirebase = false;
        }
    } else {
        console.warn("Firebase configuration is missing or invalid. Firebase features will be disabled.");
    }
    
    let userId = null;
    let isAuthReady = false;

    if (canUseFirebase) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("User is signed in with UID:", userId);
            } else {
                console.log("User is signed out, attempting to sign in...");
                try {
                    // Check for an injected custom auth token
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken && initialAuthToken.trim() !== "") {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    userId = `anonymous_fallback_${crypto.randomUUID()}`; 
                    updateResultsWithMessage(`Authentication error: ${error.message}. Data might not be saved correctly. User ID: ${userId}`, 'text-red-500');
                }
            }
            isAuthReady = true;
        });
    } else {
        // Fallback for local preview without Firebase
        userId = `local_preview_${crypto.randomUUID()}`;
        isAuthReady = true;
        console.log("Running in local/preview mode without Firebase. UserID:", userId);
    }

    function updateResultsWithMessage(message, className = 'text-gray-700') {
        const resultsDiv = document.getElementById('surveyResults');
        if (resultsDiv) {
            const p = document.createElement('p');
            p.className = className;
            p.textContent = message;
            // Prepend or append based on desired order
            const existingSavingMsg = resultsDiv.querySelector('.saving-message');
            if (existingSavingMsg) {
                resultsDiv.insertBefore(p, existingSavingMsg);
            } else {
                resultsDiv.appendChild(p);
            }
        }
    }
    
    window.saveSurveyToFirestore = async (surveyData) => {
        const resultsDiv = document.getElementById('surveyResults');
        const submitButton = document.getElementById('submitButton');

        if (!canUseFirebase) {
            console.warn("Firebase is not initialized. Simulating save.");
            updateResultsWithMessage("ملاحظة: يتم تشغيل الاستطلاع في وضع المعاينة. لن يتم حفظ البيانات بشكل دائم. / Note: Survey is in preview mode. Data will not be saved permanently.", 'font-semibold text-orange-600');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'تم الإرسال (محاكاة) / Submitted (Simulated)';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
            return;
        }

        if (!isAuthReady) {
            console.warn("Authentication is not ready yet. Retrying...");
            updateResultsWithMessage("المصادقة معلقة ... حاول مرة أخرى بعد لحظات. / Authentication pending... Retrying in a moment.", 'text-yellow-500');
            setTimeout(() => window.saveSurveyToFirestore(surveyData), 2000); // Retry after 2 seconds
            return;
        }

        if (!userId) {
            console.error("User ID is not available. Cannot save data.");
            updateResultsWithMessage("خطأ: فشل مصادقة المستخدم. لا يمكن حفظ الاستطلاع. / Error: User authentication failed. Cannot save survey.", 'text-red-500');
            if (submitButton) submitButton.disabled = false; // Re-enable button if auth fails critically
            return;
        }

        const userSurveyCollectionPath = `artifacts/${appId}/users/${userId}/geriatricSurveyResponses`;
        const surveyDocRef = doc(collection(db, userSurveyCollectionPath)); // Auto-generates ID

        try {
            await setDoc(surveyDocRef, {
                ...surveyData,
                submittedAt: serverTimestamp(),
                clientTimestamp: new Date().toISOString(),
                userId: userId, // Store authenticated user ID
                appId: appId    // Store app/survey ID for context
            });
            console.log("Survey data saved with ID: ", surveyDocRef.id);
            
            const savingMsgElement = resultsDiv.querySelector('.saving-message');
            if(savingMsgElement) savingMsgElement.textContent = 'تم حفظ بياناتك بنجاح! / Your data has been saved successfully!';
            else updateResultsWithMessage('تم حفظ بياناتك بنجاح! / Your data has been saved successfully!', 'text-green-500 font-semibold');

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = 'تم الإرسال / Submitted';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        } catch (error) {
            console.error("Error saving survey data to Firestore: ", error);
            const savingMsgElement = resultsDiv.querySelector('.saving-message');
            if(savingMsgElement) savingMsgElement.textContent = `حدث خطأ أثناء حفظ البيانات: ${error.message} / Error saving your data: ${error.message}`;
            else updateResultsWithMessage(`خطأ في حفظ الاستطلاع: ${error.message} / Error saving survey: ${error.message}`, 'text-red-500 font-semibold');
            if (submitButton) submitButton.disabled = false; // Re-enable to allow retry if desired
        }
    };
  </script>

  <script>
    let currentSection = 1;
    const sections = document.querySelectorAll('.section');
    const totalSections = sections.length;

    function showSection(index) {
      sections.forEach((sec, i) => {
        if (i === index - 1) {
          sec.classList.remove('hidden');
          sec.classList.add('block');
        } else {
          sec.classList.add('hidden');
          sec.classList.remove('block');
        }
      });
      window.scrollTo(0, 0);
    }

    function validateCurrentSection() {
        const currentSectionElement = sections[currentSection - 1];
        let allValid = true;
        
        // Remove existing custom error messages from the current section
        currentSectionElement.querySelectorAll('.input-error-message, .radio-error-message').forEach(el => el.remove());

        // Validate select, text, number inputs
        const inputs = currentSectionElement.querySelectorAll('input[required]:not([type="radio"]):not([type="checkbox"]), select[required], input[type="number"][required]');
        inputs.forEach(input => {
            if (!input.checkValidity()) {
                allValid = false;
                // input.reportValidity(); // Browser native validation bubble (optional, can be intrusive)
                const errorMsg = document.createElement('div');
                errorMsg.className = 'input-error-message'; // Defined in <style>
                errorMsg.textContent = input.validationMessage || 'This field is required.'; // Use native or generic message
                input.parentNode.insertBefore(errorMsg, input.nextSibling); // Insert after the input
            }
        });

        // Validate radio button groups
        const radioGroupNames = [...new Set(Array.from(currentSectionElement.querySelectorAll('input[type="radio"][required]')).map(radio => radio.name))];
        radioGroupNames.forEach(groupName => {
            const groupRadios = currentSectionElement.querySelectorAll(`input[name="${groupName}"][required]`);
            if (!currentSectionElement.querySelector(`input[name="${groupName}"]:checked`)) {
                allValid = false;
                const firstRadioInGroup = groupRadios[0];
                if (firstRadioInGroup) {
                    const errorMsgElement = document.createElement('div');
                    errorMsgElement.className = 'radio-error-message'; // Defined in <style>
                    errorMsgElement.textContent = 'الرجاء اختيار إجابة. / Please select an option.';
                    
                    let gdsOptionsContainer = firstRadioInGroup.closest('div.flex.space-x-4.space-x-reverse');
                    let mspssOptionsContainer = firstRadioInGroup.closest('div.likert-options-ltr');

                    if (mspssOptionsContainer) {
                        mspssOptionsContainer.insertAdjacentElement('afterend', errorMsgElement);
                    } else if (gdsOptionsContainer) {
                        gdsOptionsContainer.insertAdjacentElement('afterend', errorMsgElement);
                    } else {
                        const questionDiv = firstRadioInGroup.closest('.question');
                        if (questionDiv) {
                            questionDiv.appendChild(errorMsgElement);
                        } else {
                            firstRadioInGroup.parentElement.insertAdjacentElement('afterend', errorMsgElement);
                        }
                    }
                     // Optionally trigger native browser validation UI for the radio group
                     // if (firstRadioInGroup.form && firstRadioInGroup.form.querySelector(`input[name="${groupName}"]:invalid`)) {
                     //    firstRadioInGroup.reportValidity();
                     // }
                }
            }
        });
        return allValid;
    }

    function nextSection() {
      if (!validateCurrentSection()) return;
      if (currentSection < totalSections) {
        currentSection++;
        showSection(currentSection);
      }
    }

    function prevSection() {
      if (currentSection > 1) {
        currentSection--;
        showSection(currentSection);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
        if (totalSections > 0) {
            showSection(currentSection);
        }
        // Dynamically generate Likert scale radio buttons for MSPSS
        document.querySelectorAll('.likert-options-ltr').forEach(container => {
            const name = container.dataset.radioGroupName;
            if (!name) {
                console.warn("Could not find data-radio-group-name for Likert scale in:", container.closest('.question'));
                return;
            }
            let optionsHTML = '';
            for (let i = 1; i <= 7; i++) {
                optionsHTML += `
                    <label class="block text-center cursor-pointer flex-1 px-0.5 min-w-[2rem]">
                        <span class="text-sm">${i}</span>
                        <input type="radio" name="${name}" value="${i}" required class="block mx-auto mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 focus:ring-offset-1">
                    </label>`;
            }
            container.innerHTML = optionsHTML;
        });
    });

    document.getElementById("surveyForm").addEventListener("submit", function(e) {
      e.preventDefault();
      if (!validateCurrentSection()) { // Validate the final section before submission
          console.log("Final section validation failed.");
          // Ensure error messages are visible if validation fails on submit button click
          const finalSectionElement = sections[currentSection - 1];
          const firstInvalidElement = finalSectionElement.querySelector(':invalid');
          if (firstInvalidElement) {
              firstInvalidElement.focus(); // Focus on the first invalid element
          }
          return;
      }
      
      const form = e.target;
      const data = new FormData(form);
      const resultsDiv = document.getElementById('surveyResults');
      resultsDiv.innerHTML = `<p class="text-gray-700 saving-message">جاري حساب النتائج وحفظ البيانات... / Calculating scores and saving data...</p>`;

      // Calculate MMSE Score
      let mmseScore = 0;
      const mmseCheckboxes = form.querySelectorAll('input[name="mmse"]:checked');
      mmseCheckboxes.forEach(checkbox => {
        mmseScore += parseInt(checkbox.value);
      });

      // Calculate ADL Score
      const adlFields = ["adl_hygiene", "adl_dressing", "adl_toilet", "adl_mobility", "adl_continence", "adl_feeding"];
      let adlScore = 0;
      adlFields.forEach(field => {
          const val = data.get(field);
          if (val) adlScore += parseFloat(val);
      });

      // Calculate GDS-15 Score
      let gdsScore = 0;
      for (let i = 1; i <= 15; i++) {
        const val = data.get(`gds${i}`);
        if (val) gdsScore += parseInt(val);
      }

      // Calculate MSPSS Score
      let mspssScore = 0;
      for (let i = 1; i <= 12; i++) {
        const value = data.get(`mspss${i}`);
        if (value) {
          mspssScore += parseInt(value);
        }
      }

      // Calculate UCL-6 Score (with reverse scoring for items 3 and 6)
      let uclScore = 0;
      const uclRawValues = {};
      for (let i = 1; i <= 6; i++) {
        const val = data.get(`ucl${i}`);
        uclRawValues[`ucl${i}`] = val ? parseInt(val) : 0; // Store raw value
      }
      uclScore += uclRawValues.ucl1;
      uclScore += uclRawValues.ucl2;
      uclScore += (3 - uclRawValues.ucl3); // Reverse score
      uclScore += uclRawValues.ucl4;
      uclScore += uclRawValues.ucl5;
      uclScore += (3 - uclRawValues.ucl6); // Reverse score

      // Display scores (temporary, before Firebase message)
      resultsDiv.innerHTML = `
        <h3 class="text-lg font-semibold text-sky-600 mb-2">النتائج / Scores:</h3>
        <p class="mb-1">MMSE Score: ${mmseScore} / 30</p>
        <p class="mb-1">ADL Score: ${adlScore.toFixed(1)} / 6</p> <!-- .toFixed(1) for 0.5 values -->
        <p class="mb-1">GDS-15 Score: ${gdsScore} / 15</p>
        <p class="mb-1">MSPSS Score: ${mspssScore} / 84</p>
        <p class="mb-3">UCL-6 Score: ${uclScore} / 18</p>
        <p class="text-gray-700 font-semibold saving-message">يتم الآن حفظ بياناتك... / Saving your data...</p>
      `;
      
      // Prepare data for Firebase
      const surveyDataToSave = {
          demographics: {
              age: data.get('age'),
              gender: data.get('gender'),
              marital: data.get('marital'),
              education: data.get('education')
          },
          scores: {
            mmse: mmseScore,
            adl: adlScore,
            gds15: gdsScore,
            mspss: mspssScore,
            ucl6: uclScore,
          },
          answers: { // Store individual answers for detailed analysis
            adl: {}, gds15: {}, mspss: {}, 
            ucl6_raw: uclRawValues, // Store raw UCL values
            // MMSE: Store which items were checked
            mmse_checked_ids: Array.from(mmseCheckboxes).map(cb => cb.id || `mmse_item_val_${cb.value}_idx_${Array.from(form.querySelectorAll('input[name="mmse"]')).indexOf(cb)}`)
          }
      };
      adlFields.forEach(field => surveyDataToSave.answers.adl[field.replace('adl_','')] = data.get(field));
      for (let i = 1; i <= 15; i++) surveyDataToSave.answers.gds15[`gds${i}`] = data.get(`gds${i}`);
      for (let i = 1; i <= 12; i++) surveyDataToSave.answers.mspss[`mspss${i}`] = data.get(`mspss${i}`);

      if (window.saveSurveyToFirestore) {
          window.saveSurveyToFirestore(surveyDataToSave);
      } else {
          console.error("Firebase save function not ready or Firebase not initialized.");
          resultsDiv.innerHTML += `<p class="text-red-500 font-semibold mt-2">خطأ: تعذر الاتصال بقاعدة البيانات لحفظ البيانات. / Error: Could not connect to the database to save data.</p>`;
      }
    });
  </script>
</body>
</html>